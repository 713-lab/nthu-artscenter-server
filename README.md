# NTHU ArtsCenter Server
[![Build Status](https://travis-ci.com/713-lab/nthu-artscenter-server.svg?branch=master)](https://travis-ci.com/713-lab/nthu-artscenter-server)
[![Last Commit](https://img.shields.io/github/last-commit/713-lab/nthu-artscenter-server)](https://github.com/713-lab/nthu-artscenter-server/commits/master)
[![Docker image Status](https://img.shields.io/badge/docker-latest-blue)](https://hub.docker.com/r/chiahsin0227/nthu_artscenter_server)
[![Docker Image Size](https://img.shields.io/docker/image-size/chiahsin0227/nthu_artscenter_server)]((https://hub.docker.com/r/chiahsin0227/nthu_artscenter_server))
[![PRs Welcome](https://img.shields.io/badge/PRs-welcome-brightgreen.svg?style=flat-square)](http://makeapullrequest.com)
[![License](https://img.shields.io/github/license/713-lab/nthu-artscenter-server)](https://github.com/713-lab/nthu-artscenter-server/blob/master/LICENSE)

[Imgur](https://i.imgur.com/MolZYFvm.gif)

## Dependencies
- Typescript
- Node.js 12
- Express.js
- Sequelize
- Postgresql 
- Redis

## Pre-reqs
To build and run this app locally you will need a few things:
- Install [Node.js](https://nodejs.org/en/)
- Install [PostgreSQL](https://www.postgresql.org/download/)
- Install [Redis](https://redis.io/download)

## Getting Started

- Clone the repository
```
git clone https://github.com/713-lab/nthu-artscenter-server.git
```
- Install dependencies
```
cd <project-name>
npm install
```
- Configure PostgreSQL Server
```bash
sudo psql -c 'create database testuser;' -U postgres
sudo psql -c "CREATE USER testuser WITH PASSWORD 'testuser';" -U postgres
sudo psql -c "ALTER USER testuser WITH SUPERUSER;" -U postgres
```
- Load the environment variables
```
DB_NAME: testuser
DB_USERNAME: testuser
DB_PASSWORD: testuser
DB_HOST: localhost
DB_PORT: 5432
SERVER_URL: http://localhost:8090
SERVER_PORT: 8090
REDIS_HOST: localhost
REDIS_PORT: 6379

```
- Build and Run the server
```
npm run build
npm start
```
- Test the server
```
npm run beforetest
npm run test
```
- Run developing server with hot-loading
```
npm run dev
```

## Docker support
In Linux, you can run postgres, redis and our web server in three seperated dockers with the support of `docker link` or `open external port`. But remember it will cause safe problems when you open ports directly in productive situation. It might allow hackers to connect the database directly. Using `docker link` is a better idea because it only exposes internal ports to different docker instances.

Alternatively, we recommend to use `docker-compose` to run a complete system.

- Run with `docker` and `open external port`
```bash
docker run --name redis-1 -p 6379:6379 -d redis
docker run --name postgres-1 -p 5432:5432 -e POSTGRES_PASSWORD=testusers -e POSTGRES_USER=testuser -d postgres
docker run -it --name server-1 -p 8090:8090 -d chiahsin0227/nthu_artscenter_server 
```

- Run with `docker` and `open external port`
```bash
docker run --name redis-1 -d redis

docker run --name postgres-1 \
-e POSTGRES_PASSWORD=testusers \
-e POSTGRES_USER=testuser \
-d postgres

docker run -it --name server-1 \
--link postgres-1 --link redis-1 \
-e DB_NAME=testuser
-e DB_USERNAME=testuser
-e DB_PASSWORD=testuser
-e REDIS_HOST=redis
-e DB_HOST=postgres
-e DB_PORT=5432
-e SERVER_URL=http://localhost:8090
-p 8090:8090 \
-d chiahsin0227/nthu_artscenter_server 
```

- Run with `docker-compose`
```bash
cd <project-name>
docker-compose pull
docker-compose up
```

## Project Structure

> **Note!** Make sure you have already built the app using `npm run build`

| Name | Description |
| -------------------- | ------------------------------------------------------------ |
| **dist**             | Output JS from typescript, mv this code to real server       |
| **coverage**         | Coverage webpage generated by jest                           |
| **data**             | If run docker-compose under this folder, docker volume locates here |
| **docs**             | Docs generated by typedoc                                    |
| **public**           | Static assets that will be used client side                  |
| **script**           | Some scripts to generate fake data                           |
| **views**            | express pug files, server-side rendering                     |
| **node_modules**     | Contains all your npm dependencies                           |
| **src**              | Source code which will be compiled then stored in dist/      |
| **src/config**       | Database setting                                             |
| **src/controllers**  | Functions handles various http requests                      |
| **src/models**       | Models defined by Sequelize                                  |
| **src**/server.ts    | Entry point to your express app                              |
| **src**/app.ts       | ExpressJs Instance                                           |
| **test**             | Test files                                                   |
| .env.example         | environment variables, API keys, tokens, passwords, database URI |    
| .travis.yml          | Used to configure Travis CI build                            |
| docker-compose.yml   | Used to configure docker-compose                             |
| Dockerfile           | Used to configure docker                                     |
| jest.config.js       | Used to configure Jest running tests written in TypeScript   |
| package.json         |                                                              | 
| tsconfig.json        | Config settings for compiling server code written in TypeScript |
| tslint.json          |                                    |

# References

- [TypeScript-Node-Starter](https://github.com/microsoft/TypeScript-Node-Starter/blob/master/README.md)
- [Okta: Use TypeScript to Build a Node API with Express](https://developer.okta.com/blog/2018/11/15/node-express-typescript)


